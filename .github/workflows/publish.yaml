name: Publish
on:
  workflow_run:
    workflows: ["Check and Test"]
    branches: [main]
    types:
      - completed

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: "Checkout"
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: "Use NodeJS 14"
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: "Publish what is not already in NPM"
      env:
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      # NOTE we should add --no-verify-access with an automation token
      run: |
        echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
        npx lerna publish --no-git-tag-version --no-push from-package --yes
